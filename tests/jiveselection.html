<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Basic editor functionality tests</title>
<link rel="stylesheet" href="qunit/qunit.css" type="text/css" media="screen">
<style>
textarea{
	width: 700px;
	height: 500px;
}</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="qunit/qunit.js"></script>
<script type="text/javascript" src="qunit/runner.js"></script>
<script type="text/javascript" src="js/utils.js"></script>
<script type="text/javascript" src="../jscripts/tiny_mce/tiny_mce.js"></script>
</head>
<body>
<script type="text/javascript">
var ed;

var $j = $;



function trimContent(content) {
	if (tinymce.isOpera)
		return content.replace(/^<p>&nbsp;<\/p>/, '').replace(/<p>&nbsp;<\/p>$/, '');

	return content;
}

function normalizeContentWhitespace(content){
    return trimContent(content.replace(/[\r\n]+/g, ''));
}

function stripIEProblems(ed, html){
    //TODO: normalize styles instead
    var elem = $j("<div>" + html + "</div>").find("*").removeAttr("style").end()
            .find("img").removeAttr("height").removeAttr("width").end().get(0);
    return ed.serializer.serialize(elem, {format: "html", getInner: true});
}

function checkContent(ed, expected, message, stripProblems){
    if(message == null){
        message = "Document content";
    }

    var actual = normalizeContentWhitespace(ed.getContent());
    expected = normalizeContentWhitespace(expected);
    if(actual == expected){
        equal(actual, expected, message);
    }else{
        if(tinymce.isIE || stripProblems){
            actual = normalizeContentWhitespace(stripIEProblems(ed, actual));
            expected = normalizeContentWhitespace(stripIEProblems(ed, expected));
        }
        equal(actual, expected, message);
    }
}

function rangeEqual(value, expected){
    var result = equal(value.startContainer, expected.startContainer, "start container");
    if(!result){
        console.error("start container mismatch: actual, expected", value.startContainer, expected.startContainer);
    }
    equal(value.startOffset, expected.startOffset, "start offset");
    if(expected.collapsed && value.collapsed){
        ok(true, "collapsed");
    }else{
        result = equal(value.endContainer, expected.endContainer, "end container");
        if(!result){
            console.error("end container mismatch: actual, expected", value.endContainer, expected.endContainer);
        }
        equal(value.endOffset, expected.endOffset, "end offset");
    }
}

QUnit.config.autostart = false;
module("Jive Selection Plugin", {
	autostart: false
});

if(!tinymce.isIE){
    test("normalizeRange, collapsed, start of body", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody();
        rng.setStart(testItem, 0);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        equal(rng.startContainer, testItem, "container");
        equal(rng.startOffset, 0, "offset");
    });

    test("normalizeRange, collapsed, start of ul", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild;
        rng.setStart(testItem, 0);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var n = rng.startContainer.childNodes[rng.startOffset];
        equal(n.nodeType, 1, "should select li node");
        equal(n.nodeName.toLowerCase(), "li", "should be the li");
    });

    test("normalizeRange, collapsed, start of li", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem, 0);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var n = rng.startContainer;
        equal(n.nodeType, 3, "should select text node");
        equal(n.nodeValue, "text", "should be the text node with the content 'text'");
        equal(rng.startOffset, 0, "should be the beginning of the text node");
    });

    test("normalizeRange, collapsed, li[1]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem, 1);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var n = rng.startContainer;
        equal(n.nodeType, 3, "should select text node");
        equal(n.nodeValue, "text", "should be the text node with the content 'text'");
        equal(rng.startOffset, 0, "should be the beginning of the text node");
    });

    test("normalizeRange, collapsed, text[0]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild.childNodes[1];
        rng.setStart(testItem, 0);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var n = rng.startContainer;
        equal(n.nodeType, 3, "should select text node");
        equal(n.nodeValue, "text", "should be the text node with the content 'text'");
        equal(rng.startOffset, 0, "should be the beginning of the text node");
    });

    test("normalizeRange, collapsed, text[1]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild.childNodes[1];
        rng.setStart(testItem, 1);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var n = rng.startContainer;
        equal(n.nodeType, 3, "should select text node");
        equal(n.nodeValue, "text", "should be the text node with the content 'text'");
        equal(rng.startOffset, 1, "should be at second spot in the text node");
    });

    test("normalizeRange, collapsed, text[-1]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild.childNodes[1];
        rng.setStart(testItem, 4);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var n = rng.startContainer;
        equal(n.nodeType, 3, "should select text node");
        equal(n.nodeValue, "text", "should be the text node with the content 'text'");
        equal(rng.startOffset, 4, "should be the start of the text node");
    });

    test("normalizeRange, collapsed, after text node", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem, 2);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var n = rng.startContainer;
        equal(n.nodeType, 3, "should select text node");
        equal(n.nodeValue, "text", "should be the text node with the content 'text'");
        equal(rng.startOffset, 4, "should be the start of the text node");
    });

    test("normalizeRange, collapsed, start of strong", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild.childNodes[2];
        rng.setStart(testItem, 0);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var n = rng.startContainer;
        equal(n.nodeType, 3, "should select text node");
        equal(n.nodeValue, "text", "should be the text node with the content 'text'");
        equal(rng.startOffset, 4, "should be the start of the text node");
    });

    test("normalizeRange, collapsed, end of strong", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild.childNodes[2];
        rng.setStart(testItem, 1);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var n = rng.startContainer;
        equal(n.nodeType, 3, "should select text node");
        equal(n.nodeValue, "bold text", "should be the text node with the content 'bold text'");
        equal(rng.startOffset, 9, "should be the start of the text node");
    });

    test("normalizeRange, collapsed, after b", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem, 3);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var n = rng.startContainer;
        equal(n.nodeType, 3, "should select text node");
        equal(n.nodeValue, "bold text", "should be the text node with the content 'bold text'");
        equal(rng.startOffset, 9, "should be the start of the text node");
    });

    test("normalizeRange, collapsed, end of ul", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild;
        rng.setStart(testItem, 1);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        equal(rng.startContainer, testItem, "ul container");
        equal(rng.startOffset, 1, "unmoved");
    });

    test("normalizeRange, selection, body[0] to body[-1]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody();
        rng.setStart(testItem, 0);
        rng.setEnd(testItem, 1);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(ed.getBody().firstChild.firstChild.childNodes[1], 0);
        expectedRng.setEnd(ed.getBody().lastChild.lastChild.lastChild, 9);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, selection, whole body", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody();
        rng.setStart(ed.getBody().firstChild.firstChild.childNodes[1], 0);
        rng.setEnd(ed.getBody().lastChild.lastChild, 4);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(ed.getBody().firstChild.firstChild.childNodes[1], 0);
        expectedRng.setEnd(ed.getBody().lastChild.lastChild.lastChild, 9);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, selection, ul[0] to ul[-1]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild;
        rng.setStart(testItem, 0);
        rng.setEnd(testItem, 1);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(ed.getBody().firstChild.firstChild.childNodes[1], 0);
        expectedRng.setEnd(ed.getBody().lastChild.lastChild.lastChild, 9);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, selection, li[1] to li[2]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem, 1);
        rng.setEnd(testItem, 2);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        var textNode = testItem.childNodes[1];
        expectedRng.setStart(textNode, 0);
        expectedRng.setEnd(textNode, textNode.nodeValue.length);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, selection, li[2] to li[3]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem, 2);
        rng.setEnd(testItem, 3);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        var textNode = testItem.childNodes[2].firstChild;
        expectedRng.setStart(textNode, 0);
        expectedRng.setEnd(textNode, textNode.nodeValue.length);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, selection, li[2] to strong[1]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem, 2);
        rng.setEnd(testItem.childNodes[2], 1);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        var textNode = testItem.childNodes[2].firstChild;
        expectedRng.setStart(textNode, 0);
        expectedRng.setEnd(textNode, textNode.nodeValue.length);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, selection, 'bold text'[2] to 'more text'[4]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem.childNodes[2].firstChild, 2);
        rng.setEnd(testItem.childNodes[3], 4);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem.childNodes[2].firstChild, 2);
        expectedRng.setEnd(testItem.childNodes[3], 4);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, selection, li[0] to strong[1]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem, 0);
        rng.setEnd(testItem.childNodes[2], 1);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem.childNodes[1], 0);
        expectedRng.setEnd(testItem.childNodes[2].firstChild, 9);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, selection, body[0] to strong[1]", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem.childNodes[1], 0);
        rng.setEnd(testItem.childNodes[2], 1);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem.childNodes[1], 0);
        expectedRng.setEnd(testItem.childNodes[2].firstChild, 9);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, selection, strong[0] to end", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem.childNodes[2].firstChild, 0);
        rng.setEnd(testItem, 4);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem.childNodes[2].firstChild, 0);
        expectedRng.setEnd(testItem.lastChild, 9);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, complex formatting, cursor between bold and italic", function(){
        ed.setContent('<p>text<strong>bold text</strong><em>italic text</em><span _mce_style="font-size: 12pt;" style="font-size: 12pt;">12 pt text</span><br></p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.childNodes[1].firstChild;
        rng.setStart(testItem, testItem.nodeValue.length);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        equal(rng.startContainer.nodeValue, "bold text", "collapsed cursor should prefer the previous text node");
        ok(rng.collapsed, "range is collapsed");
    });

    test("normalizeRange, complex formatting, cursor between bold and italic, starting in italic text", function(){
        ed.setContent('<p>text<strong>bold text</strong><em>italic text</em><span _mce_style="font-size: 12pt;" style="font-size: 12pt;">12 pt text</span><br></p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.childNodes[2].firstChild;
        rng.setStart(testItem, 0);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        equal(rng.startContainer.nodeValue, "bold text", "collapsed cursor should prefer the previous text node");
        ok(rng.collapsed, "range is collapsed");
    });

    test("normalizeRange, complex formatting, select italic text", function(){
        ed.setContent('<p>text<strong>bold text</strong><em>italic text</em><span _mce_style="font-size: 12pt;" style="font-size: 12pt;">12 pt text</span><br></p>');

        var rng = ed.dom.createRng();
        var boldText= ed.getBody().firstChild.childNodes[1].firstChild;
        var italicText= ed.getBody().firstChild.childNodes[2].firstChild;
        rng.setStart(boldText, 9);
        rng.setEnd(italicText, 11);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        equal(rng.startContainer.nodeValue, "italic text", "start should prefer the next text node");
        equal(rng.startOffset, 0, "start should prefer the next text node");
        equal(rng.endContainer, rng.startContainer, "same node selected");
        equal(rng.endOffset, rng.endContainer.nodeValue.length, "end of selection should be end of italic text node");
    });

    test("normalizeRange, collapsed, beginning of list item with br", function(){
        ed.setContent('<p><br /></p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild;
        rng.setStart(testItem, 0);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem, 0);
        expectedRng.collapse(true);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, link, beginning of strongold after link", function(){
        ed.setContent('<p>text<a href="http://www.google.com/">link</a><strong>bold text</strong></p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.childNodes[2].firstChild;
        rng.setStart(testItem, 0);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem, 0);
        expectedRng.collapse(true);

        rangeEqual(rng, expectedRng);
        ok(rng.collapsed, "range is collapsed");
    });

    test("normalizeRange, link, end of link", function(){
        ed.setContent('<p>text<a href="http://www.google.com/">link</a><strong>bold text</strong></p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.childNodes[1].firstChild;
        rng.setStart(testItem, 4);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem, 4);
        expectedRng.collapse(true);

        rangeEqual(rng, expectedRng);
        ok(rng.collapsed, "range is collapsed");
    });

    test("normalizeRange, link, beginning of link", function(){
        ed.setContent('<p>text<a href="http://www.google.com/">link</a><strong>bold text</strong></p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.childNodes[1].firstChild;
        rng.setStart(testItem, 0);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem, 0);
        expectedRng.collapse(true);

        rangeEqual(rng, expectedRng);
        ok(rng.collapsed, "range is collapsed");
    });

    test("normalizeRange, link, end of text before link", function(){
        ed.setContent('<p>text<a href="http://www.google.com/">link</a><strong>bold text</strong></p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem, 4);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem, 4);
        expectedRng.collapse(true);

        rangeEqual(rng, expectedRng);
        ok(rng.collapsed, "range is collapsed");
    });

    test("normalizeRange, br, after br mid-p", function(){
        ed.setContent('<p>text<br />more text</p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild;
        rng.setStart(testItem, 2);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem.childNodes[2], 0);
        expectedRng.collapse(true);

        rangeEqual(rng, expectedRng);
        ok(rng.collapsed, "range is collapsed");
    });

    test("normalizeRange, multiple text nodes in p, selection", function(){
        ed.setContent('<p>text </p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild;

        while(testItem.lastChild.nodeType == 1){
            testItem.removeChild(testItem.lastChild);  //gecko likes to add brs, which throw us off
        }
        testItem.appendChild(ed.getDoc().createTextNode("more text "));
        testItem.appendChild(ed.getDoc().createTextNode("end text"));

        rng.setStart(testItem.childNodes[1], 2);
        rng.setEnd(testItem.childNodes[2], 0);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem.firstChild, 7);
        expectedRng.setEnd(testItem.firstChild, 15);

        rangeEqual(rng, expectedRng);
        equal(rng.toString(), "re text ", "correct selected text");
    });

    test("normalizeRange, cursor after image", function(){
        ed.setContent('<p>text <img class="jive_macro jive_emote" src="/4.5.5/images/emoticons/happy.gif" jivemacro="emoticon" ___jive_emoticon_name="happy" /> more text</p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild;

        while(testItem.lastChild.nodeType == 1){
            testItem.removeChild(testItem.lastChild);  //gecko likes to add brs, which throw us off
        }

        rng.setStart(testItem.childNodes[2], 0);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem.lastChild, 0);
        expectedRng.collapse(true);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, cursor before image", function(){
        ed.setContent('<p>text <img class="jive_macro jive_emote" src="/4.5.5/images/emoticons/happy.gif" jivemacro="emoticon" ___jive_emoticon_name="happy" /> more text</p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild;

        while(testItem.lastChild.nodeType == 1){
            testItem.removeChild(testItem.lastChild);  //gecko likes to add brs, which throw us off
        }

        rng.setStart(testItem, 1);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem.firstChild, 5);
        expectedRng.collapse(true);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, cursor before image at start of p", function(){
        ed.setContent('<p><img class="jive_macro jive_emote" src="/4.5.5/images/emoticons/happy.gif" jivemacro="emoticon" ___jive_emoticon_name="happy" /> more text</p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild;

        while(testItem.lastChild.nodeType == 1){
            testItem.removeChild(testItem.lastChild);  //gecko likes to add brs, which throw us off
        }

        rng.setStart(testItem, 0);
        rng.collapse(true);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem, 0);
        expectedRng.collapse(true);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, select starts before image at start of p", function(){
        ed.setContent('<p><img class="jive_macro jive_emote" src="/4.5.5/images/emoticons/happy.gif" jivemacro="emoticon" ___jive_emoticon_name="happy" /> more text</p>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild;

        while(testItem.lastChild.nodeType == 1){
            testItem.removeChild(testItem.lastChild);  //gecko likes to add brs, which throw us off
        }
        testItem.insertBefore(ed.getDoc().createTextNode(""), testItem.firstChild);

        rng.setStart(testItem, 0);
        rng.setEnd(testItem, 3);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(testItem, 0);
        expectedRng.setEnd(testItem.lastChild, 10);

        rangeEqual(rng, expectedRng);
    });

    test("normalizeRange, select into empty p", function(){
        ed.setContent('<p>some text</p><p><br /></p>');

        var rng = ed.dom.createRng();
        rng.setStart(ed.getBody().firstChild, 0);
        rng.setEnd(ed.getBody().lastChild, 0);

        rng = ed.plugins.jiveselection.normalizeRange(rng);

        var expectedRng = ed.dom.createRng();
        expectedRng.setStart(ed.getBody().firstChild.firstChild, 0);
        expectedRng.setEnd(ed.getBody().lastChild, 0);

        rangeEqual(rng, expectedRng);
    });

    if(tinymce.isGecko){
        test("delete entire h3", function(){
            ed.setContent('<h3>some text</h3><h3>more text</h3><p>para</p>');

            var rng = ed.dom.createRng();
            rng.setStart(ed.getBody().firstChild.firstChild, 0);
            rng.setEnd(ed.getBody().childNodes[1], 0);
            ed.selection.setRng(rng);

            type(ed, 8);

            equal(ed.getContent().replace(/[\r\n]+/g, ''), '<h3>more text</h3><p>para</p>');
        });
    }

    test("range stability under normalization, first node inner", function(){
        ed.setContent("<p>one </p>");

        var p = ed.getBody().firstChild;
        while(p.lastChild.nodeType == 1){
            p.removeChild(p.lastChild);  //gecko likes to add brs, which throw us off
        }

        var doc = ed.getDoc();
        p.appendChild(doc.createTextNode("two "));
        p.appendChild(doc.createTextNode("three"));

        equal(p.childNodes.length, 3, "separate children");

        var rng = doc.createRange();
        rng.setStart(p.firstChild, 0);
        rng.setEnd(p.firstChild, 3);

        rng = ed.plugins.jiveselection.safeNormalize(rng);

        var expected = doc.createRange();
        expected.setStart(p.firstChild, 0);
        expected.setEnd(p.firstChild, 3);

        equal(p.childNodes.length, 3, "separate children");
        rangeEqual(rng, expected);
        equal(rng.toString(), "one");
    });

    test("selection stability under normalization", function(){
        ed.setContent("<p>one </p>");

        var p = ed.getBody().firstChild;
        while(p.lastChild.nodeType == 1){
            p.removeChild(p.lastChild);  //gecko likes to add brs, which throw us off
        }

        var doc = ed.getDoc();
        p.appendChild(doc.createTextNode("two "));
        p.appendChild(doc.createTextNode("three"));

        equal(p.childNodes.length, 3, "separate children");

        var rng = doc.createRange();
        rng.setStart(p.lastChild, 1);
        rng.collapse(true);
        ed.plugins.jiveselection.setSelection(rng, true);

        var selRng = ed.selection.getRng(true);
        selRng = ed.plugins.jiveselection.safeNormalize(selRng, p);
        ed.selection.setRng(selRng);

        var expected = doc.createRange();
        expected.setStart(p.firstChild, 9);
        expected.collapse(true);

        equal(p.childNodes.length, 1, "one text node");
        rangeEqual(ed.selection.getRng(), expected);
    });

    test("range stability under normalization, first node boundaries", function(){
        ed.setContent("<p>one </p>");

        var p = ed.getBody().firstChild;
        while(p.lastChild.nodeType == 1){
            p.removeChild(p.lastChild);  //gecko likes to add brs, which throw us off
        }

        var doc = ed.getDoc();
        p.appendChild(doc.createTextNode("two "));
        p.appendChild(doc.createTextNode("three"));

        var rng = doc.createRange();
        rng.setStart(p.firstChild, 0);
        rng.setEnd(p.firstChild, 4);

        rng = ed.plugins.jiveselection.safeNormalize(rng);

        var expected = doc.createRange();
        expected.setStart(p.firstChild, 0);
        expected.setEnd(p.firstChild, 4);

        equal(p.childNodes.length, 3, "separate children");
        rangeEqual(rng, expected);
        equal(rng.toString(), "one ");
    });

    test("range stability under normalization, first node start, collapsed", function(){
        ed.setContent("<p>one </p>");

        var p = ed.getBody().firstChild;
        while(p.lastChild.nodeType == 1){
            p.removeChild(p.lastChild);  //gecko likes to add brs, which throw us off
        }

        var doc = ed.getDoc();
        p.appendChild(doc.createTextNode("two "));
        p.appendChild(doc.createTextNode("three"));

        var rng = doc.createRange();
        rng.setStart(p.firstChild, 0);
        rng.setEnd(p.firstChild, 0);

        rng = ed.plugins.jiveselection.safeNormalize(rng);

        var expected = doc.createRange();
        expected.setStart(p.firstChild, 0);
        expected.setEnd(p.firstChild, 0);

        equal(p.childNodes.length, 3, "separate children");
        rangeEqual(rng, expected);
        equal(rng.toString(), "");
    });

    test("range stability under normalization, first[0] - second[0]", function(){
        ed.setContent("<p>one </p>");

        var p = ed.getBody().firstChild;
        while(p.lastChild.nodeType == 1){
            p.removeChild(p.lastChild);  //gecko likes to add brs, which throw us off
        }

        var doc = ed.getDoc();
        p.appendChild(doc.createTextNode("two "));
        p.appendChild(doc.createTextNode("three"));

        var rng = doc.createRange();
        rng.setStart(p.firstChild, 0);
        rng.setEnd(p.firstChild.nextSibling, 0);

        rng = ed.plugins.jiveselection.safeNormalize(rng);

        var expected = doc.createRange();
        expected.setStart(p.firstChild, 0);
        expected.setEnd(p.firstChild, 4);

        equal(p.childNodes.length, 1, "one child");
        rangeEqual(rng, expected);
        equal(rng.toString(), "one ");
    });

    test("range stability under normalization, second[0] - second[3]", function(){
        ed.setContent("<p>one </p>");

        var p = ed.getBody().firstChild;
        while(p.lastChild.nodeType == 1){
            p.removeChild(p.lastChild);  //gecko likes to add brs, which throw us off
        }

        var doc = ed.getDoc();
        p.appendChild(doc.createTextNode("two "));
        p.appendChild(doc.createTextNode("three"));

        var rng = doc.createRange();
        rng.setStart(p.firstChild.nextSibling, 0);
        rng.setEnd(p.firstChild.nextSibling, 3);

        rng = ed.plugins.jiveselection.safeNormalize(rng);

        equal(p.childNodes.length, 3, "separate children");

        var expected = doc.createRange();
        expected.setStart(p.firstChild.nextSibling, 0);
        expected.setEnd(p.firstChild.nextSibling, 3);

        rangeEqual(rng, expected);
        equal(rng.toString(), "two");
    });

    test("range stability under normalization, second[0] - third[3]", function(){
        ed.setContent("<p>one </p>");

        var p = ed.getBody().firstChild;
        while(p.lastChild.nodeType == 1){
            p.removeChild(p.lastChild);  //gecko likes to add brs, which throw us off
        }

        var doc = ed.getDoc();
        p.appendChild(doc.createTextNode("two "));
        p.appendChild(doc.createTextNode("three"));

        var rng = doc.createRange();
        rng.setStart(p.firstChild.nextSibling, 0);
        rng.setEnd(p.firstChild.nextSibling.nextSibling, 3);

        rng = ed.plugins.jiveselection.safeNormalize(rng);

        var expected = doc.createRange();
        expected.setStart(p.firstChild, 4);
        expected.setEnd(p.firstChild, 11);

        equal(p.childNodes.length, 1, "one child");
        rangeEqual(rng, expected);
        equal(rng.toString(), "two thr");
    });

    test("atStartOf, true", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem.firstChild, 0);
        rng.collapse(true);
        ed.selection.setRng(rng);

        equal(ed.plugins.jiveselection.atStartOf(testItem), true, "start of span is start of li");
    });

    test("atStartOf, true, exact", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem, 0);
        rng.collapse(true);
        ed.selection.setRng(rng);

        equal(ed.plugins.jiveselection.atStartOf(testItem), true, "start of li is start of li");
    });

    test("atStartOf, false", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setStart(testItem.childNodes[2], 0);
        rng.collapse(true);
        ed.selection.setRng(rng);

        equal(ed.plugins.jiveselection.atStartOf(testItem), false, "start of strong is not start of li");
    });

    test("atEndOf, true", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong><em>more text</em></li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setEnd(testItem.lastChild.lastChild, testItem.lastChild.lastChild.nodeValue.length);
        rng.collapse(false);
        ed.selection.setRng(rng);

        equal(ed.plugins.jiveselection.atEndOf(testItem), true, "end of em is end of li");
    });

    test("atEndOf, true, exact", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setEnd(testItem, testItem.childNodes.length);
        rng.collapse(false);
        ed.selection.setRng(rng);

        equal(ed.plugins.jiveselection.atEndOf(testItem), true, "end of li is end of li");
    });

    test("atEndOf, true, with br", function(){
        ed.setContent('<ul><li><br /></li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setEnd(testItem, 0);
        rng.collapse(false);
        ed.selection.setRng(rng);

        equal(ed.plugins.jiveselection.atEndOf(testItem), true, "ignored terminal br");
    });

    test("atEndOf, true, in p with terminal br before list", function() {
        ed.setContent('<p>para text<br /></p><ul><li>first</li><li>second</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild;
        rng.setStart(testItem.firstChild, 9);
        rng.collapse(true);
        ed.selection.setRng(rng);

        equal(ed.plugins.jiveselection.atEndOf(testItem), true, "ignored terminal br");
    });


    test("atEndOf, false", function(){
        ed.setContent('<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>');

        var rng = ed.dom.createRng();
        var testItem = ed.getBody().firstChild.firstChild;
        rng.setEnd(testItem.childNodes[2].firstChild, 9);
        rng.collapse(false);
        ed.selection.setRng(rng);

        equal(ed.plugins.jiveselection.atEndOf(testItem), false, "end of strong is not end of li");
    });
}

test("isForward", function(){
    ed.setContent('<p>test</p>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild;
    rng.setStart(testItem, 0);
    rng.collapse(true);
    ed.selection.setRng(rng);

    ok(ed.plugins.jiveselection.isForwardSelection(), "collapsed is forward");

    rng.setEnd(testItem, 1);
    ed.selection.setRng(rng);

    ok(ed.plugins.jiveselection.isForwardSelection(), "uncollapsed forward is forward");

    var sel = ed.selection.getSel();
    if(sel.anchorNode != null){
        sel.collapse(testItem, 1);
        sel.extend(testItem, 0);
        ok(!ed.plugins.jiveselection.isForwardSelection(), "uncollapsed backward is not forward");
    }
});

test("isBookmark", function(){
    ed.setContent('<p id="foo">test</p>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild;
    rng.setStart(testItem, 0);
    rng.collapse(true);
    ed.selection.setRng(rng);

    var bm = ed.selection.getBookmark();

    ok(ed.plugins.jiveselection.isBookmark(testItem.childNodes[0]), "isBookmark on elem");
    ok(ed.plugins.jiveselection.isBookmark(testItem.childNodes[0].id), "isBookmark on id");
    ok(!ed.plugins.jiveselection.isBookmark(testItem), "isBookmark on non-bookmark elem");
    ok(!ed.plugins.jiveselection.isBookmark("foo"), "isBookmark on non-bookmark id");
});

test("removeBookmark", function(){
    ed.setContent('<p id="foo">test</p>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild;
    rng.setStart(testItem, 0);
    rng.setEnd(testItem, 1);
    ed.selection.setRng(rng);

    var bm = ed.selection.getBookmark();
    ed.plugins.jiveselection.removeBookmark(bm);

    var $body = $j(ed.getBody());
    equal($body.find("p#foo").length, 1, "p tag");
    equal($body.find("p#foo").text(), "test", "text");
    equal($body.find("span").length, 0, "0 span tags");
});

test("adjustForBookmark, include", function(){
    ed.setContent('<p id="foo">test</p>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild;
    rng.setStart(testItem, 0);
    rng.setEnd(testItem, 1);
    ed.selection.setRng(rng);

    var bm = ed.selection.getBookmark();
    var result = ed.selection.getRng(true);
    ed.plugins.jiveselection.adjustForBookmark(result, true);
    ok(ed.plugins.jiveselection.isBookmark(result.startContainer.childNodes[result.startOffset]), "starts with bookmark");
    ok(ed.plugins.jiveselection.isBookmark(result.endContainer.childNodes[result.endOffset-1]), "ends with bookmark");
});

test("adjustForBookmark, exclude", function(){
    ed.setContent('<p id="foo">test</p>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild;
    rng.setStart(testItem, 0);
    rng.setEnd(testItem, 1);
    ed.selection.setRng(rng);

    var bm = ed.selection.getBookmark();
    var result = ed.selection.getRng(true);
    ed.plugins.jiveselection.adjustForBookmark(result, false);
    ok(ed.plugins.jiveselection.isBookmark(result.startContainer.childNodes[result.startOffset-1]), "starts after bookmark");
    ok(ed.plugins.jiveselection.isBookmark(result.endContainer.childNodes[result.endOffset]), "ends before bookmark");
});

test("getExpandedBlockRange", function(){
    ed.setContent('<p>one</p><p>two</p>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild;
    rng.setStart(testItem.firstChild, 1);
    rng.setEnd(testItem.nextSibling.firstChild, 2);

    var result = ed.plugins.jiveselection.getExpandedBlockRange(rng);
    var expected = ed.dom.createRng();
    expected.setStart(ed.getBody(), 0);
    expected.setEnd(ed.getBody(), 2);

    rangeEqual(result, expected);
});

test("getExpandedBlockRange in mostly-empty td", function(){
    ed.setContent('<table><tbody><tr><td><br /></td><td></td></tr></tbody></table>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild.firstChild.firstChild.firstChild;
    rng.setStart(testItem, 0);
    rng.collapse(true);

    var result = ed.plugins.jiveselection.getExpandedBlockRange(rng);
    var expected = ed.dom.createRng();
    expected.setStart(testItem, 0);
    expected.setEnd(testItem, 1);

    rangeEqual(result, expected);
});

test("getExpandedBlockRange in empty td", function(){
    ed.setContent('<table><tbody><tr><td><br /></td><td></td></tr></tbody></table>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild.firstChild.firstChild.lastChild;
    rng.setStart(testItem, 0);
    rng.collapse(true);

    var result = ed.plugins.jiveselection.getExpandedBlockRange(rng);
    var expected = ed.dom.createRng();
    expected.setStart(testItem, 0);
    expected.setEnd(testItem, testItem.childNodes.length);

    rangeEqual(result, expected);
});

test("splitAtEndpoints, all text in p", function(){
    ed.setContent('<p>text</p>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild;
    rng.setStart(testItem.firstChild, 0);
    rng.setEnd(testItem.firstChild, 4);

    var result = ed.plugins.jiveselection.splitAtEndpoints(rng);
    var expected = ed.dom.createRng();
    testItem = ed.getBody();
    expected.setStart(testItem, 0);
    expected.setEnd(testItem, 1);

    rangeEqual(result, expected);
    checkContent(ed, '<p>text</p>', "correct document");
});

test("splitAtEndpoints, whole element", function(){
    ed.setContent('<p><strong>first paragraph</strong></p><p>second paragraph</p>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild;
    rng.setStart(testItem.firstChild, 0);
    rng.setEnd(testItem, 1);

    var result = ed.plugins.jiveselection.splitAtEndpoints(rng);
    var expected = ed.dom.createRng();
    testItem = ed.getBody();
    expected.setStart(testItem, 0);
    expected.setEnd(testItem, 1);

    rangeEqual(result, expected);
    equal(ed.getContent().replace(/[\r\n]+/g, ''), '<p><strong>first paragraph</strong></p><p>second paragraph</p>', "correct document");
});

test("splitAtEndpoints, whole element, just text", function(){
    ed.setContent('<p><strong>first paragraph</strong></p><p>second paragraph</p>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild;
    rng.setStart(testItem.firstChild.firstChild, 0);
    rng.setEnd(testItem.firstChild.firstChild, 15);

    var result = ed.plugins.jiveselection.splitAtEndpoints(rng);

    var expected = ed.dom.createRng();
    testItem = ed.getBody().firstChild;
    expected.setStart(testItem, 0);
    expected.setEnd(testItem, 1);

    rangeEqual(result, expected);
    equal(ed.getContent().replace(/[\r\n]+/g, ''), '<p><strong>first paragraph</strong></p><p>second paragraph</p>', "correct document");
});

test("splitAtEndpoints, first word", function(){
    ed.setContent('<p><strong>first paragraph</strong></p><p>second paragraph</p>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild.firstChild.firstChild;
    rng.setStart(testItem, 0);
    rng.setEnd(testItem, 5);

    var result = ed.plugins.jiveselection.splitAtEndpoints(rng);
    var expected = ed.dom.createRng();
    testItem = ed.getBody().firstChild;
    expected.setStart(testItem, 0);
    expected.setEnd(testItem, 1);

    rangeEqual(result, expected);
    equal(ed.getContent().replace(/[\r\n]+/g, ''), '<p><strong>first</strong><strong> paragraph</strong></p><p>second paragraph</p>', "correct document");
});

test("splitAtEndpoints, second word, to top", function(){
    ed.setContent('<p><strong>first paragraph</strong></p><p>second paragraph</p>');

    var rng = ed.dom.createRng();
    rng.setStart(ed.getBody().firstChild.firstChild.firstChild, 5);
    rng.setEnd(ed.getBody(), 1);

    var result = ed.plugins.jiveselection.splitAtEndpoints(rng);
    var expected = ed.dom.createRng();
    var testItem = ed.getBody();
    expected.setStart(testItem, 1);
    expected.setEnd(testItem, 2);

    rangeEqual(result, expected);
    equal(ed.getContent().replace(/[\r\n]+/g, ''), '<p><strong>first</strong></p><p><strong> paragraph</strong></p><p>second paragraph</p>', "correct document");
});

test("splitAtEndpoints in td", function(){
    ed.setContent('<table><tbody><tr><td>someatextain a TD</td><td></td></tr></tbody></table><p>asdf</p>');

    var rng = ed.dom.createRng();
    var testItem = ed.getBody().firstChild.firstChild.firstChild.firstChild;
    rng.setStart(testItem.firstChild, 5);
    rng.setEnd(testItem.firstChild, 9);

    var result = ed.plugins.jiveselection.splitAtEndpoints(rng);
    var expected = ed.dom.createRng();
    expected.setStart(testItem, 1);
    expected.setEnd(testItem, 2);

    rangeEqual(result, expected);

    var pre = ed.dom.create("pre");
    result.surroundContents(pre);

    checkContent(ed, '<table><tbody><tr><td>somea<pre>text</pre>ain a TD</td><td></td></tr></tbody></table><p>asdf</p>');
});



tinyMCE.init({
	mode : "exact",
	elements : "elm1",
	theme : "advanced",
	plugins : 'jiveselection',
	add_unload_trigger : false,
	theme_advanced_styles : 'test1=test1;test2=test2',
	valid_styles : {
		'*' : 'text-align,padding-left,color,font-size,font-family,background-color,font-weight,font-style,text-decoration,float,margin,margin-top,margin-right,margin-bottom,margin-left,display'
	},
	apply_source_formatting : 0,
	        valid_elements : ""
                    +"a[accesskey|charset|class|coords|dir<ltr?rtl|href|hreflang|id|lang|name"
                      +"|onblur|onclick|ondblclick|onfocus|onkeydown|onkeypress|onkeyup"
                      +"|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|rel|rev"
                      +"|shape<circle?default?poly?rect|style|tabindex|title|target|type|jivemacro|_.*],"
                    +"abbr[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"acronym[class|dir<ltr?rtl|id|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"address[class|align|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown"
                      +"|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover"
                      +"|onmouseup|style|title],"
                    +"applet[align<bottom?left?middle?right?top|alt|archive|class|code|codebase"
                      +"|height|hspace|id|name|object|style|title|vspace|width],"
                    +"area[accesskey|alt|class|coords|dir<ltr?rtl|href|id|lang|nohref<nohref"
                      +"|onblur|onclick|ondblclick|onfocus|onkeydown|onkeypress|onkeyup"
                      +"|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup"
                      +"|shape<circle?default?poly?rect|style|tabindex|title|target],"
                    +"base[href|target],"
                    +"basefont[color|face|id|size],"
                    +"bdo[class|dir<ltr?rtl|id|lang|style|title],"
                    +"big[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"blockquote[cite|class|dir<ltr?rtl|id|lang|onclick|ondblclick"
                      +"|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout"
                      +"|onmouseover|onmouseup|style|title],"
                    +"body[alink|background|bgcolor|class|dir<ltr?rtl|id|lang|link|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onload|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|onunload|style|title|text|vlink],"
                    +"br[class|clear<all?left?none?right|id|style|title],"
                    +"button[accesskey|class|dir<ltr?rtl|disabled<disabled|id|lang|name|onblur"
                      +"|onclick|ondblclick|onfocus|onkeydown|onkeypress|onkeyup|onmousedown"
                      +"|onmousemove|onmouseout|onmouseover|onmouseup|style|tabindex|title|type"
                      +"|value],"
                    +"caption[align<bottom?left?right?top|class|dir<ltr?rtl|id|lang|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|style|title],"
                    +"center[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"cite[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"code[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"col[align<center?char?justify?left?right|char|charoff|class|dir<ltr?rtl|id"
                      +"|lang|onclick|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown"
                      +"|onmousemove|onmouseout|onmouseover|onmouseup|span|style|title"
                      +"|valign<baseline?bottom?middle?top|width],"
                    +"colgroup[align<center?char?justify?left?right|char|charoff|class|dir<ltr?rtl"
                      +"|id|lang|onclick|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown"
                      +"|onmousemove|onmouseout|onmouseover|onmouseup|span|style|title"
                      +"|valign<baseline?bottom?middle?top|width],"
                    +"dd[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress|onkeyup"
                      +"|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style|title],"
                    +"del[cite|class|datetime|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown"
                      +"|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover"
                      +"|onmouseup|style|title],"
                    +"dfn[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"dir[class|compact<compact|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown"
                      +"|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover"
                      +"|onmouseup|style|title],"
                    +"div[align<center?justify?left?right|class|dir<ltr?rtl|id|lang|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|style|title],"
                    +"dl[class|compact<compact|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown"
                      +"|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover"
                      +"|onmouseup|style|title],"
                    +"dt[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress|onkeyup"
                      +"|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style|title],"
                    +"em/i[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"embed[width|height|src|pluginspage|name|swliveconnect|play<true?false|loop<true?false"
                      + "|menu<true?false|quality<low?autolow?autohigh?high?medium?high?best"
                      + "|scale<default?exact?noorder|salign<l?t?r?b?tl?tr?bl?br|wmode<window?opaque?transparent"
                      + "|bgcolor|base|flashvars|type|allowfullscreen],"
                    +"fieldset[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"font[class|color|dir<ltr?rtl|face|id|lang|size|style|title],"
                    +"form[accept|accept-charset|action|class|dir<ltr?rtl|enctype|id|lang"
                      +"|method<get?post|name|onclick|ondblclick|onkeydown|onkeypress|onkeyup"
                      +"|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|onreset|onsubmit"
                      +"|style|title|target],"
                    +"frame[class|frameborder|id|longdesc|marginheight|marginwidth|name"
                      +"|noresize<noresize|scrolling<auto?no?yes|src|style|title],"
                    +"frameset[class|cols|id|onload|onunload|rows|style|title],"
                    +"h1[align<center?justify?left?right|class|dir<ltr?rtl|id|lang|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|style|title],"
                    +"h2[align<center?justify?left?right|class|dir<ltr?rtl|id|lang|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|style|title],"
                    +"h3[align<center?justify?left?right|class|dir<ltr?rtl|id|lang|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|style|title],"
                    +"h4[align<center?justify?left?right|class|dir<ltr?rtl|id|lang|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|style|title],"
                    +"h5[align<center?justify?left?right|class|dir<ltr?rtl|id|lang|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|style|title],"
                    +"h6[align<center?justify?left?right|class|dir<ltr?rtl|id|lang|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|style|title],"
                    +"head[dir<ltr?rtl|lang|profile],"
                    +"hr[align<center?left?right|class|dir<ltr?rtl|id|lang|noshade<noshade|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|size|style|title|width],"
                    +"html[dir<ltr?rtl|lang|version],"
                    +"iframe[align<bottom?left?middle?right?top|class|frameborder|height|id"
                      +"|longdesc|marginheight|marginwidth|name|scrolling<auto?no?yes|src|style"
                      +"|title|width],"
                    +"img[align<bottom?left?middle?right?top|alt|border|class|dir<ltr?rtl|height"
                      +"|hspace|id|ismap<ismap|lang|longdesc|name|onclick|ondblclick|onkeydown"
                      +"|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover"
                      +"|onmouseup|src|style|title|usemap|vspace|width|jivemacro|_.*|param_.*],"
                    +"input[accept|accesskey|align<bottom?left?middle?right?top|alt"
                      +"|checked<checked|class|dir<ltr?rtl|disabled<disabled|id|ismap<ismap|lang"
                      +"|maxlength|name|onblur|onclick|ondblclick|onfocus|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|onselect"
                      +"|readonly<readonly|size|src|style|tabindex|title"
                      +"|type<button?checkbox?file?hidden?image?password?radio?reset?submit?text"
                      +"|usemap|value],"
                    +"ins[cite|class|datetime|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown"
                      +"|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover"
                      +"|onmouseup|style|title],"
                    +"isindex[class|dir<ltr?rtl|id|lang|prompt|style|title],"
                    +"kbd[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"label[accesskey|class|dir<ltr?rtl|for|id|lang|onblur|onclick|ondblclick"
                      +"|onfocus|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout"
                      +"|onmouseover|onmouseup|style|title],"
                    +"legend[align<bottom?left?right?top|accesskey|class|dir<ltr?rtl|id|lang"
                      +"|onclick|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|style|title],"
                    +"li[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress|onkeyup"
                      +"|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style|title|type],"
                    +"link[charset|class|dir<ltr?rtl|href|hreflang|id|lang|media|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|rel|rev|style|title|target|type],"
                    +"map[class|dir<ltr?rtl|id|lang|name|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"menu[class|compact<compact|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown"
                      +"|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover"
                      +"|onmouseup|style|title],"
                    +"meta[content|dir<ltr?rtl|http-equiv|lang|name|scheme],"
                    +"noframes[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"noscript[class|dir<ltr?rtl|id|lang|style|title],"
                    +"object[align<bottom?left?middle?right?top|archive|border|class|classid"
                      +"|codebase|codetype|data|declare|dir<ltr?rtl|height|hspace|id|lang|name"
                      +"|onclick|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|standby|style|tabindex|title|type|usemap"
                      +"|vspace|width],"
                    +"ol[class|compact<compact|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown"
                      +"|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover"
                      +"|onmouseup|start|style|title|type],"
                    +"optgroup[class|dir<ltr?rtl|disabled<disabled|id|label|lang|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|style|title],"
                    +"option[class|dir<ltr?rtl|disabled<disabled|id|label|lang|onclick|ondblclick"
                      +"|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout"
                      +"|onmouseover|onmouseup|selected<selected|style|title|value],"
                    +"p[align<center?justify?left?right|class|dir<ltr?rtl|id|lang|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|style|title],"
                    +"param[id|name|type|value|valuetype<DATA?OBJECT?REF],"
                    +"pre/listing/plaintext/xmp[align|class|dir<ltr?rtl|id|lang|onclick|ondblclick"
                      +"|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout"
                      +"|onmouseover|onmouseup|style|title|width|jivemacro|_.*],"
                    +"q[cite|class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"s[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress|onkeyup"
                      +"|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style|title],"
                    +"samp[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"script[charset|defer|language|src|type],"
                    +"select[class|dir<ltr?rtl|disabled<disabled|id|lang|multiple<multiple|name"
                      +"|onblur|onchange|onclick|ondblclick|onfocus|onkeydown|onkeypress|onkeyup"
                      +"|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|size|style"
                      +"|tabindex|title],"
                    +"small[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"span[align<center?justify?left?right|class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown"
                      +"|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover"
                      +"|onmouseup|style|title|jivemacro|_.*],"
                    +"strike[class|class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown"
                      +"|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover"
                      +"|onmouseup|style|title],"
                    +"strong/b[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"style[dir<ltr?rtl|lang|media|title|type],"
                    +"sub[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"sup[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title],"
                    +"table[align<center?left?right|bgcolor|border|cellpadding|cellspacing|class"
                      +"|dir<ltr?rtl|frame|height|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|rules"
                      +"|style|summary|title|width],"
                    +"tbody[align<center?char?justify?left?right|char|class|charoff|dir<ltr?rtl|id"
                      +"|lang|onclick|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown"
                      +"|onmousemove|onmouseout|onmouseover|onmouseup|style|title"
                      +"|valign<baseline?bottom?middle?top],"
                    +"td[abbr|align<center?char?justify?left?right|axis|bgcolor|char|charoff|class"
                      +"|colspan|dir<ltr?rtl|headers|height|id|lang|nowrap<nowrap|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|rowspan|scope<col?colgroup?row?rowgroup"
                      +"|style|title|valign<baseline?bottom?middle?top|width],"
                    +"textarea[accesskey|class|cols|dir<ltr?rtl|disabled<disabled|id|lang|name"
                      +"|onblur|onclick|ondblclick|onfocus|onkeydown|onkeypress|onkeyup"
                      +"|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|onselect"
                      +"|readonly<readonly|rows|style|tabindex|title],"
                    +"tfoot[align<center?char?justify?left?right|char|charoff|class|dir<ltr?rtl|id"
                      +"|lang|onclick|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown"
                      +"|onmousemove|onmouseout|onmouseover|onmouseup|style|title"
                      +"|valign<baseline?bottom?middle?top],"
                    +"th[abbr|align<center?char?justify?left?right|axis|bgcolor|char|charoff|class"
                      +"|colspan|dir<ltr?rtl|headers|height|id|lang|nowrap<nowrap|onclick"
                      +"|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
                      +"|onmouseout|onmouseover|onmouseup|rowspan|scope<col?colgroup?row?rowgroup"
                      +"|style|title|valign<baseline?bottom?middle?top|width],"
                    +"thead[align<center?char?justify?left?right|char|charoff|class|dir<ltr?rtl|id"
                      +"|lang|onclick|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown"
                      +"|onmousemove|onmouseout|onmouseover|onmouseup|style|title"
                      +"|valign<baseline?bottom?middle?top],"
                    +"title[dir<ltr?rtl|lang],"
                    +"tr[abbr|align<center?char?justify?left?right|bgcolor|char|charoff|class"
                      +"|rowspan|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title|valign<baseline?bottom?middle?top],"
                    +"tt[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress|onkeyup"
                      +"|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style|title],"
                    +"u[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress|onkeyup"
                      +"|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style|title],"
                    +"ul[class|compact<compact|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown"
                      +"|onkeypress|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover"
                      +"|onmouseup|style|title|type],"
                    +"var[class|dir<ltr?rtl|id|lang|onclick|ondblclick|onkeydown|onkeypress"
                      +"|onkeyup|onmousedown|onmousemove|onmouseout|onmouseover|onmouseup|style"
                      +"|title]",
	init_instance_callback : function(ed) {
		window.ed = ed;

		ed.onNodeChange.addToTop(function() {
			return false;
		});

		QUnit.start();
	}
});
</script>

	<h1 id="qunit-header">Unit tests for the Jive Selection plugin</h1>
	<h2 id="qunit-banner"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>

	<textarea id="elm1" name="elm1"></textarea>
	<div>
		<a href="javascript:alert(tinymce.EditorManager.get('wysiwygtext').getContent({format : 'raw'}));">[getRawContents]</a>
		<a href="javascript:alert(tinymce.EditorManager.get('wysiwygtext').getContent());">[getContents]</a>
	</div>
</body>
</html>
